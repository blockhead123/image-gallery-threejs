!function(k){k.fn.ig3js=function(e){var d,l,p,c,f,g,h,w,m,u,E=k.extend({dx:300,dz:300,deltaRotation:45,planeSizeW:500,planeSizeH:500,manifest:[],imagePath:"",alphaBackground:!0,antialias:!0,progress:{light:"#ff0000",ambientLight:"#ffffff",position:[0,100,0]},onImageLoadProgress:null,onImageLoadComplete:null,onImageLoad:null,onNavigateComplete:null,stats:!1,canvasWindow:{defaultWidth:window.innerWidth,defaultHeight:window.innerHeight}},e),i=this,v=0,x=.8,y=E.planeSizeW,T=E.planeSizeH,H=E.dx,R=E.dz,z=2,M=E.deltaRotation,L=0,P=E.manifest,W=E.imagePath,C=0;function o(e){u<=++v&&(v=0);for(var t=0,n=0;n<u;n++)t=g[n],(t+=e)<0?t=u-1:u<=t&&(t-=u),g[n]=t;I(!1)}i.init=function(){d=new THREE.Scene,wndw={innerWidth:E.canvasWindow.defaultWidth,innerHeight:E.canvasWindow.defaultHeight},(l=new THREE.PerspectiveCamera(45,wndw.innerWidth/wndw.innerHeight,1,2e4)).position.set(0,100,1e3),d.add(l),p=Detector.webgl?new THREE.WebGLRenderer({antialias:E.antialias,alpha:E.alphaBackground}):new THREE.CanvasRenderer;var e=this[0];e.appendChild(p.domElement);var t=new THREE.PointLight(E.progress.light);t.position.set(500,500,0),d.add(t);t=new THREE.AmbientLight(E.progress.ambientLight);d.add(t),(h=new THREE.Object3D).position.y=T/2,d.add(h);var n=new THREE.Object3D;n.position.set(E.progress.position[0],E.progress.position[1],E.progress.position[2]),d.add(n);var i=new THREE.Mesh(new THREE.PlaneGeometry(500,30,1,1),new THREE.MeshBasicMaterial({color:"#0f0f2e",transparent:!0}));n.add(i);var o=new THREE.Mesh(new THREE.PlaneGeometry(494,24,1,1),new THREE.MeshBasicMaterial({color:"#00e5e5",transparent:!0}));o.position.set(0,0,1),o.scale.x=0,n.add(o);var a=new createjs.LoadQueue(!1,W);function r(){d.remove(n)}function s(){u=P.length,w=[],m=[],L=Math.floor((u-1)/2),g=[];for(var e=0,t=0,n=v;n<v+u;n++)u<=(e=n)&&(e-=u),g[e]=t,t++;for(n=0;n<u;n++){m[n]={side:1,dif:0,rotation:0};var i=new THREE.Texture(a.getResult(P[n].id));i.needsUpdate=!0;i=new THREE.MeshBasicMaterial({map:i,depthWrite:!0,depthTest:!0,transparent:!0}),i=new THREE.Mesh(new THREE.PlaneGeometry(y,T),i);i.overdraw=!0,i.name=P[n].id,i.position.x=n*H,h.add(i),w[n]=i}document.addEventListener("mousedown",D,!1),I(!0)}a.addEventListener("progress",function(e){TweenMax.to(o.scale,.5,{x:e.progress})}),a.addEventListener("complete",function(e){TweenMax.to(i.material,.5,{opacity:0,delay:.5}),TweenMax.to(o.material,.5,{opacity:0,delay:.5,onComplete:r}),setTimeout(s,1e3)}),a.addEventListener("fileload",function(e){}),a.loadManifest(P),c=new THREE.Raycaster,1==E.stats&&((f=new Stats).domElement.style.position="absolute",f.domElement.style.left="0px",f.domElement.style.top="0px",f.domElement.style.zIndex=100,e.appendChild(f.domElement)),window.addEventListener("resize",S,!1),S(),B()};var b=function(e,t,n){e==C&&i.triggerEvent("on-navigate-complete",n[C])};function I(e){var t,n,i=!0,o=1,a=1,r=0,s=0,d=x;!0===e&&(d=0);var l=0;!1===e&&(l=0);for(var p=0;p<u;p++)0===(s=g[p])?(t=s*H,i=!0,o=1,m[p].side=r=0,m[p].dif=0):(s<=L?(t=s*H,o=s<=z?1:0,i=!(z+3<s),r=-s*M,m[p].side=1):(t=-(s=-(s-u))*H,o=s<=z?1:0,i=!(z+3<s),r=s*M,m[p].side=2),m[p].dif=s),0!==d&&(a=!0===i?1:0),n=s*R,w[p].visible=i,0==r&&(C=p),TweenMax.to(w[p].position,d*a,{x:t,z:-n,delay:l*s*x/3,onComplete:b,onCompleteParams:[p,r,w]}),TweenMax.to(w[p].rotation,d*a,{y:r*Math.PI/180,delay:l*s*x/3}),TweenMax.to(w[p].material,d*a,{opacity:o,delay:l*s*x/3}),setTimeout(j,75*d)}function j(){0}function a(e){var t,n;if(0===m[v=e].side)console.log("click action");else for(n=1===m[e].side?-1:1,t=0;t<m[e].dif;t++)setTimeout(o,100*t,n)}i.navigate={next:function(){m.length>C+1?a(C+1):a(0)},prev:function(){a(0<C?C-1:m.length-1)},goTo:function(e){a(e)}};function t(e){TweenMax.to(n,1,{x:e.position.x,y:e.position.y,z:e.position.z,onUpdate:function(){l.position.set(this.target.x,this.target.y,this.target.z)}}),TweenMax.to(r,1,{x:e.rotation.x*Math.PI/180,y:e.rotation.y*Math.PI/180,z:e.rotation.z*Math.PI/180,onUpdate:function(){console.log(this.target.x),l.rotation.x=this.target.x,l.rotation.y=this.target.y,l.rotation.z=this.target.z}})}var n={x:0,y:100,z:1e3},r={x:0,y:0,z:0};function S(){l.aspect=wndw.innerWidth/wndw.innerHeight,l.updateProjectionMatrix(),p.setSize(wndw.innerWidth,wndw.innerHeight),s()}function B(){requestAnimationFrame(B),1==E.stats&&f.update(),s()}function s(){p.render(d,l)}function D(e){e.preventDefault();e=new THREE.Vector3(e.clientX/wndw.innerWidth*2-1,2*-(e.clientY/wndw.innerHeight)+1,.5);c.setFromCamera(e,l);var t=c.intersectObjects(h.children);if(0<t.length){for(var n=0;n<u&&w[n]!==t[0].object;n++);m[n].dif<=z&&a(n)}}i.perspective={default:function(){t({position:{x:0,y:100,z:1e3},rotation:{x:0,y:0,z:0}})},topRight:function(){t({position:{x:600,y:700,z:800},rotation:{x:-30,y:30,z:15}})},topLeft:function(){t({position:{x:-600,y:700,z:800},rotation:{x:-30,y:-30,z:-15}})}};function G(e,t){0!=e&&e(t)}return i.triggerEvent=function(e,t){"on-image-load-complete"!=e?"on-image-load-progress"!=e?"on-image-load"!=e?"on-navigate-complete"==e&&G(E.onNavigateComplete,t):G(E.onImageLoad,this):G(E.onImageLoadProgress,this):G(E.onImageLoadComplete,this)},i.init(),i}}(jQuery);