!function(k){k.fn.ig3js=function(e){var d,l,c,p,g,h,f,w,m,u,E=k.extend({dx:300,dz:300,deltaRotation:45,planeSizeW:500,planeSizeH:500,manifest:[],imagePath:"",alphaBackground:!0,antialias:!0,progress:{light:"#ff0000",ambientLight:"#ffffff",position:[0,100,0]},onImageLoadProgress:null,onImageLoadComplete:null,onImageLoad:null,onNavigateComplete:null,stats:!1,canvasWindow:{defaultWidth:window.innerWidth,defaultHeight:window.innerHeight}},e),v=this,x=0,y=.8,T=E.planeSizeW,H=E.planeSizeH,R=E.dx,z=E.dz,M=2,L=E.deltaRotation,P=0,W=E.manifest,C=E.imagePath,b=0;function i(e){u<=++x&&(x=0);for(var t=0,n=0;n<u;n++)t=h[n],(t+=e)<0?t=u-1:u<=t&&(t-=u),h[n]=t;j(!1)}v.init=function(){d=new THREE.Scene,wndw={innerWidth:v.width(),innerHeight:500},(l=new THREE.PerspectiveCamera(45,wndw.innerWidth/wndw.innerHeight,1,2e4)).position.set(0,100,1e3),d.add(l),c=Detector.webgl?new THREE.WebGLRenderer({antialias:E.antialias,alpha:E.alphaBackground}):new THREE.CanvasRenderer;var e=this[0];e.appendChild(c.domElement);var t=new THREE.PointLight(E.progress.light);t.position.set(500,500,0),d.add(t);t=new THREE.AmbientLight(E.progress.ambientLight);d.add(t),(f=new THREE.Object3D).position.y=H/2,d.add(f);var n=new THREE.Object3D;n.position.set(E.progress.position[0],E.progress.position[1],E.progress.position[2]),d.add(n);var i=new THREE.Mesh(new THREE.PlaneGeometry(500,30,1,1),new THREE.MeshBasicMaterial({color:"#0f0f2e",transparent:!0}));n.add(i);var o=new THREE.Mesh(new THREE.PlaneGeometry(494,24,1,1),new THREE.MeshBasicMaterial({color:"#00e5e5",transparent:!0}));o.position.set(0,0,1),o.scale.x=0,n.add(o);var r=new createjs.LoadQueue(!1,C);function a(){d.remove(n)}function s(){u=W.length,w=[],m=[],P=Math.floor((u-1)/2),h=[];for(var e=0,t=0,n=x;n<x+u;n++)u<=(e=n)&&(e-=u),h[e]=t,t++;for(n=0;n<u;n++){m[n]={side:1,dif:0,rotation:0};var i=new THREE.Texture(r.getResult(W[n].id)),o=i.image.width/i.image.height/(T/H),a=1;o<1&&(a/=o,o=1),i.needsUpdate=!0;i=new THREE.MeshBasicMaterial({map:i,depthWrite:!0,depthTest:!0,transparent:!0}),i=new THREE.Mesh(new THREE.PlaneGeometry(T,H),i);i.overdraw=!0,i.name=W[n].id,i.position.x=n*R,i.scale.x=o,i.scale.y=a,console.log(),f.add(i),w[n]=i}document.addEventListener("mousedown",G,!1),j(!0)}r.addEventListener("progress",function(e){TweenMax.to(o.scale,.5,{x:e.progress})}),r.addEventListener("complete",function(e){TweenMax.to(i.material,.5,{opacity:0,delay:.5}),TweenMax.to(o.material,.5,{opacity:0,delay:.5,onComplete:a}),setTimeout(s,1e3)}),r.addEventListener("fileload",function(e){}),r.loadManifest(W),p=new THREE.Raycaster,1==E.stats&&((g=new Stats).domElement.style.position="absolute",g.domElement.style.left="0px",g.domElement.style.top="0px",g.domElement.style.zIndex=100,e.appendChild(g.domElement)),window.addEventListener("resize",B,!1),B(),D()};var I=function(e,t,n){e==b&&v.triggerEvent("on-navigate-complete",n[b])};function j(e){var t,n,i=!0,o=1,a=1,r=0,s=0,d=y;!0===e&&(d=0);var l=0;!1===e&&(l=0);for(var c=0;c<u;c++)0===(s=h[c])?(t=s*R,i=!0,o=1,m[c].side=r=0,m[c].dif=0):(s<=P?(t=s*R,o=s<=M?1:0,i=!(M+3<s),r=-s*L,m[c].side=1):(t=-(s=-(s-u))*R,o=s<=M?1:0,i=!(M+3<s),r=s*L,m[c].side=2),m[c].dif=s),0!==d&&(a=!0===i?1:0),n=s*z,w[c].visible=i,0==r&&(b=c),TweenMax.to(w[c].position,d*a,{x:t,z:-n,delay:l*s*y/3,onComplete:I,onCompleteParams:[c,r,w]}),TweenMax.to(w[c].rotation,d*a,{y:r*Math.PI/180,delay:l*s*y/3}),TweenMax.to(w[c].material,d*a,{opacity:o,delay:l*s*y/3}),setTimeout(S,75*d)}function S(){0}function o(e){var t,n;if(0===m[x=e].side)console.log("click action");else for(n=1===m[e].side?-1:1,t=0;t<m[e].dif;t++)setTimeout(i,100*t,n)}v.navigate={next:function(){m.length>b+1?o(b+1):o(0)},prev:function(){o(0<b?b-1:m.length-1)},goTo:function(e){o(e)}};function t(e){TweenMax.to(n,1,{x:e.position.x,y:e.position.y,z:e.position.z,onUpdate:function(){l.position.set(this.target.x,this.target.y,this.target.z)}}),TweenMax.to(a,1,{x:e.rotation.x*Math.PI/180,y:e.rotation.y*Math.PI/180,z:e.rotation.z*Math.PI/180,onUpdate:function(){console.log(this.target.x),l.rotation.x=this.target.x,l.rotation.y=this.target.y,l.rotation.z=this.target.z}})}var n={x:0,y:100,z:1e3},a={x:0,y:0,z:0};function B(){l.aspect=wndw.innerWidth/wndw.innerHeight,l.updateProjectionMatrix(),c.setSize(wndw.innerWidth,wndw.innerHeight),r()}function D(){requestAnimationFrame(D),1==E.stats&&g.update(),r()}function r(){v.find("canvas").width(v.width()),v.find("canvas").height(E.canvasWindow.defaultHeight),c.render(d,l),l.aspect=v.width()/E.canvasWindow.defaultHeight,l.updateProjectionMatrix()}function G(e){e.preventDefault();e=new THREE.Vector3(e.clientX/wndw.innerWidth*2-1,2*-(e.clientY/wndw.innerHeight)+1,.5);p.setFromCamera(e,l);var t=p.intersectObjects(f.children);if(0<t.length){for(var n=0;n<u&&w[n]!==t[0].object;n++);m[n].dif<=M&&o(n)}}v.perspective={default:function(){t({position:{x:0,y:100,z:1e3},rotation:{x:0,y:0,z:0}})},topRight:function(){t({position:{x:600,y:700,z:800},rotation:{x:-30,y:30,z:15}})},topLeft:function(){t({position:{x:-600,y:700,z:800},rotation:{x:-30,y:-30,z:-15}})}};function s(e,t){0!=e&&e(t)}return v.triggerEvent=function(e,t){"on-image-load-complete"!=e?"on-image-load-progress"!=e?"on-image-load"!=e?"on-navigate-complete"==e&&s(E.onNavigateComplete,t):s(E.onImageLoad,this):s(E.onImageLoadProgress,this):s(E.onImageLoadComplete,this)},v.init(),v}}(jQuery);